<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Recording Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .primary {
            background-color: #4CAF50;
            color: white;
        }
        .danger {
            background-color: #f44336;
            color: white;
        }
        .secondary {
            background-color: #e7e7e7;
            color: black;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .alert-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Voice Recording Test</h1>
    
    <div class="alert alert-info">
        <p>This is a minimal test page for voice recording. Use this to test your browser's microphone permissions and audio recording capabilities.</p>
        <p>If recording works here but not in the main app, the issue is likely with how the app is handling the audio data, not the browser permissions.</p>
    </div>
    
    <div class="card">
        <h2>Microphone Status</h2>
        <div id="mic-status" class="alert alert-secondary">Ready to test</div>
        
        <div>
            <button id="request-permission" class="primary">Request Microphone Permission</button>
        </div>
        
        <div id="recording-controls" style="display: none; margin-top: 15px;">
            <button id="start-recording" class="primary">Start Recording</button>
            <button id="stop-recording" class="danger" style="display: none;">Stop Recording</button>
        </div>
        
        <div id="recording-info" style="margin-top: 15px;">
            <div id="recording-time" style="font-size: 24px; font-weight: bold;">00:00</div>
        </div>
    </div>
    
    <div class="card">
        <h2>Audio Playback</h2>
        <div id="audio-container" style="display: none;">
            <audio id="audio-player" controls></audio>
            <div style="margin-top: 10px;">
                <button id="download-audio" class="secondary">Download Audio</button>
            </div>
        </div>
        <div id="no-audio" class="alert alert-info">Record something to play it back</div>
    </div>
    
    <div class="card">
        <h2>Debug Information</h2>
        <div>
            <h3>Browser Info</h3>
            <pre id="browser-info"></pre>
        </div>
        <div>
            <h3>Debug Log</h3>
            <div id="debug-log" class="log-container"></div>
        </div>
    </div>
    
    <script>
        // Global variables
        let mediaRecorder;
        let audioChunks = [];
        let recordingInterval;
        let recordingSeconds = 0;
        let audioBlob;
        
        // DOM Elements
        const micStatus = document.getElementById('mic-status');
        const requestPermissionBtn = document.getElementById('request-permission');
        const startRecordingBtn = document.getElementById('start-recording');
        const stopRecordingBtn = document.getElementById('stop-recording');
        const recordingControls = document.getElementById('recording-controls');
        const recordingTime = document.getElementById('recording-time');
        const audioPlayer = document.getElementById('audio-player');
        const audioContainer = document.getElementById('audio-container');
        const noAudio = document.getElementById('no-audio');
        const downloadAudioBtn = document.getElementById('download-audio');
        const browserInfoElement = document.getElementById('browser-info');
        const debugLog = document.getElementById('debug-log');
        
        // Debug logging
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);
            
            const entry = document.createElement('div');
            entry.textContent = `[${timestamp}] ${message}`;
            debugLog.appendChild(entry);
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        // Format time for display
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }
        
        // Start recording timer
        function startRecordingTimer() {
            recordingSeconds = 0;
            updateRecordingTime();
            recordingInterval = setInterval(() => {
                recordingSeconds++;
                updateRecordingTime();
            }, 1000);
        }
        
        // Stop recording timer
        function stopRecordingTimer() {
            clearInterval(recordingInterval);
            recordingInterval = null;
        }
        
        // Update recording time display
        function updateRecordingTime() {
            recordingTime.textContent = formatTime(recordingSeconds);
        }
        
        // Request microphone permission
        requestPermissionBtn.addEventListener('click', () => {
            log('Requesting microphone permission');
            micStatus.className = 'alert alert-info';
            micStatus.textContent = 'Requesting microphone access...';
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    log('Microphone permission granted');
                    log(`Audio tracks: ${stream.getAudioTracks().length}`);
                    
                    stream.getAudioTracks().forEach((track, i) => {
                        log(`Track ${i}: ${track.label}, ${track.kind}`);
                        log(`Settings: ${JSON.stringify(track.getSettings())}`);
                    });
                    
                    micStatus.className = 'alert alert-success';
                    micStatus.textContent = 'Microphone access granted!';
                    
                    // Store stream and show recording controls
                    window.microphoneStream = stream;
                    requestPermissionBtn.style.display = 'none';
                    recordingControls.style.display = 'block';
                })
                .catch(err => {
                    log(`Error accessing microphone: ${err.name} - ${err.message}`);
                    micStatus.className = 'alert alert-danger';
                    micStatus.textContent = `Microphone access error: ${err.message}`;
                });
        });
        
        // Start recording
        startRecordingBtn.addEventListener('click', () => {
            if (!window.microphoneStream) {
                log('No microphone stream available');
                return;
            }
            
            log('Starting recording');
            audioChunks = [];
            
            // Update UI
            startRecordingBtn.style.display = 'none';
            stopRecordingBtn.style.display = 'inline-block';
            micStatus.className = 'alert alert-danger';
            micStatus.textContent = 'Recording in progress...';
            
            // Start timer
            startRecordingTimer();
            
            try {
                // Find supported MIME types
                let mimeType = '';
                const types = [
                    'audio/webm',
                    'audio/webm;codecs=opus',
                    'audio/ogg;codecs=opus',
                    'audio/mp4',
                    'audio/mpeg'
                ];
                
                for (const type of types) {
                    if (MediaRecorder.isTypeSupported(type)) {
                        mimeType = type;
                        log(`Using MIME type: ${mimeType}`);
                        break;
                    }
                }
                
                // Create media recorder
                const options = mimeType ? { mimeType, audioBitsPerSecond: 128000 } : {};
                log(`MediaRecorder options: ${JSON.stringify(options)}`);
                mediaRecorder = new MediaRecorder(window.microphoneStream, options);
                
                mediaRecorder.addEventListener('dataavailable', event => {
                    log(`Data available event: chunk size=${event.data.size}, type=${event.data.type}`);
                    audioChunks.push(event.data);
                });
                
                mediaRecorder.addEventListener('start', () => {
                    log('MediaRecorder started');
                });
                
                mediaRecorder.addEventListener('error', err => {
                    log(`MediaRecorder error: ${err}`);
                });
                
                // Start with 1 second chunks
                mediaRecorder.start(1000);
                log(`Recording started, state: ${mediaRecorder.state}`);
            } catch (err) {
                log(`Error creating MediaRecorder: ${err.name} - ${err.message}`);
                micStatus.className = 'alert alert-danger';
                micStatus.textContent = `Recording error: ${err.message}`;
                
                // Reset UI
                startRecordingBtn.style.display = 'inline-block';
                stopRecordingBtn.style.display = 'none';
                stopRecordingTimer();
            }
        });
        
        // Stop recording
        stopRecordingBtn.addEventListener('click', () => {
            if (!mediaRecorder) {
                log('No media recorder available');
                return;
            }
            
            log(`Stopping recording, state: ${mediaRecorder.state}`);
            
            // Update UI
            stopRecordingBtn.style.display = 'none';
            micStatus.className = 'alert alert-info';
            micStatus.textContent = 'Processing recording...';
            
            // Stop timer
            stopRecordingTimer();
            
            // Stop the recorder
            try {
                mediaRecorder.addEventListener('stop', () => {
                    log('MediaRecorder stopped');
                    log(`Audio chunks collected: ${audioChunks.length}`);
                    processRecording();
                });
                
                mediaRecorder.stop();
            } catch (err) {
                log(`Error stopping MediaRecorder: ${err.message}`);
                micStatus.className = 'alert alert-danger';
                micStatus.textContent = `Error stopping recording: ${err.message}`;
                
                startRecordingBtn.style.display = 'inline-block';
            }
        });
        
        // Process the recording
        function processRecording() {
            try {
                // Get MIME type from first chunk if available
                let mimeType = 'audio/webm';
                if (audioChunks.length > 0 && audioChunks[0].type) {
                    mimeType = audioChunks[0].type;
                    log(`Using MIME type from chunk: ${mimeType}`);
                }
                
                // Create the blob
                audioBlob = new Blob(audioChunks, { type: mimeType });
                log(`Audio blob created: size=${audioBlob.size} bytes, type=${audioBlob.type}`);
                
                // Create object URL
                const audioURL = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioURL;
                
                // Show audio player
                audioContainer.style.display = 'block';
                noAudio.style.display = 'none';
                
                // Update UI
                micStatus.className = 'alert alert-success';
                micStatus.textContent = 'Recording completed successfully';
                startRecordingBtn.style.display = 'inline-block';
                
                // Set up download button
                downloadAudioBtn.addEventListener('click', () => {
                    const a = document.createElement('a');
                    a.href = audioURL;
                    a.download = `recording_${Date.now()}.${mimeType.includes('ogg') ? 'ogg' : 'webm'}`;
                    a.click();
                });
            } catch (err) {
                log(`Error processing recording: ${err.message}`);
                micStatus.className = 'alert alert-danger';
                micStatus.textContent = `Error processing recording: ${err.message}`;
                startRecordingBtn.style.display = 'inline-block';
            }
        }
        
        // Display browser information
        function showBrowserInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                'Platform': navigator.platform,
                'AppVersion': navigator.appVersion,
                'Vendor': navigator.vendor,
                'Language': navigator.language,
                'Online': navigator.onLine,
                'Cookies Enabled': navigator.cookieEnabled,
                'Secure Context': window.isSecureContext,
                'MediaDevices API': !!navigator.mediaDevices,
                'getUserMedia API': !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                'MediaRecorder API': typeof MediaRecorder !== 'undefined',
                'AudioContext API': typeof (window.AudioContext || window.webkitAudioContext) !== 'undefined'
            };
            
            browserInfoElement.textContent = JSON.stringify(info, null, 2);
        }
        
        // Initialize the page
        window.addEventListener('DOMContentLoaded', () => {
            log('Page loaded');
            showBrowserInfo();
        });
    </script>
</body>
</html>
