{% extends "base.html" %}

{% block styles %}
{{ super() }}
<style>
    .chat-container {
        max-height: 550px;
        overflow-y: auto;
        padding: 1rem;
    }
    
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        border-radius: 15px 15px 0 15px;
    }
    
    .assistant-message {
        background-color: #f0f0f0;
        color: #333;
        margin-right: auto;
        border-radius: 15px 15px 15px 0;
    }
    
    .system-message {
        background-color: #d4edda;
        color: #155724;
        margin: 10px auto;
        border-radius: 10px;
        width: 90%;
        font-size: 0.9em;
    }
    
    .message-content {
        padding: 10px 15px;
        margin-bottom: 5px;
        max-width: 80%;
    }
    
    .message-time {
        font-size: 0.7em;
        opacity: 0.8;
    }
    
    /* Стилизация кнопок команд */
    .action-button {
        margin-top: 10px;
        margin-right: 5px;
        font-size: 0.85em;
    }
    
    /* Анимация для индикатора загрузки */
    .typing-indicator {
        display: none;
        padding: 10px 15px;
        background-color: #f0f0f0;
        border-radius: 15px 15px 15px 0;
        margin-bottom: 10px;
        width: 70px;
    }
    
    .typing-indicator span {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #999;
        margin-right: 5px;
        animation: typing 1s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
        margin-right: 0;
    }
    
    @keyframes typing {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container" data-session-id="{{ session.id }}">
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ session.session_name }}</h5>
                    <div>
                        <span class="badge bg-info">{{ session.excel_file.original_filename }}</span>
                        <span class="badge bg-secondary">{{ session.messages.count() }} messages</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Chat Messages -->
                    <div id="chat-messages" class="chat-container">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="d-flex mb-3 {{ 'justify-content-end' if message.is_user_message else 'justify-content-start' }}">
                                    {% if message.message_type.value == 'system' %}
                                        <div class="system-message message-content">
                                            {{ message.content|nl2br }}
                                            <div class="message-time">{{ message.timestamp.strftime('%H:%M') }}</div>
                                        </div>
                                    {% else %}
                                        <div class="{{ 'user-message' if message.is_user_message else 'assistant-message' }} message-content"
                                             data-message-id="{{ message.id }}">
                                            {% if message.message_type.value == 'voice' and message.is_user_message %}
                                                <small><i class="fas fa-microphone me-1"></i>{{ _('Voice Message') }}</small><br>
                                            {% endif %}
                                            {{ message.content|nl2br }}
                                            
                                            {% if not message.is_user_message %}
                                                <div class="action-buttons mt-2" data-message-id="{{ message.id }}">
                                                    <button class="btn btn-sm btn-outline-primary parse-ai-actions-btn">
                                                        <i class="fas fa-magic"></i> {{ _('Process Actions') }}
                                                    </button>
                                                </div>
                                            {% endif %}
                                            
                                            <div class="message-time">{{ message.timestamp.strftime('%H:%M') }}</div>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted p-4">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p>{{ _('Start chatting with your Excel Assistant!') }}</p>
                                <p class="small">{{ _('Ask questions about your Excel data or use the quick actions on the right.') }}</p>
                            </div>
                        {% endif %}
                        
                        <!-- Индикатор набора текста -->
                        <div class="typing-indicator" id="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="border-top p-3">
                        <form id="chat-form" method="POST" action="{{ url_for('api.send_message') }}">
                            {{ form.hidden_tag() }}
                            <input type="hidden" name="session_id" value="{{ session.id }}">
                            <div class="row g-2">
                                <div class="col">
                                    {{ form.message(class="form-control", id="message-input", placeholder=_("Type your message..."), rows="2") }}
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col">
                                    {{ form.submit(class="btn btn-primary", id="send-button") }}
                                </div>
                                <div class="col-auto">
                                    <button type="button" id="voice-button" class="btn btn-outline-primary">
                                        <i class="fas fa-microphone"></i> {{ _('Voice') }}
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- File Information -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">{{ _('File Information') }}</h6>
                </div>
                <div class="card-body">
                    <p><strong>{{ _('File') }}:</strong> {{ session.excel_file.original_filename }}</p>
                    <p><strong>{{ _('Size') }}:</strong> {{ session.excel_file.file_size|filesizeformat }}</p>
                    <p><strong>{{ _('Permissions') }}:</strong> 
                        <span class="badge bg-{{ 'success' if session.excel_file.permission_mode.value == 'read_write_delete' else 'warning' if session.excel_file.permission_mode.value == 'read_write' else 'secondary' }}">
                            {{ session.excel_file.get_permission_mode_display() }}
                        </span>
                    </p>
                    <p><strong>{{ _('Sheets') }}:</strong> {{ session.excel_file.sheet_names.count(',') + 1 if session.excel_file.sheet_names else 0 }}</p>
                    
                    <div class="d-grid">
                        <a href="{{ url_for('main.view_file', file_id=session.excel_file.id) }}" class="btn btn-outline-primary btn-sm">
                            {{ _('View File') }}
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">{{ _('Quick Actions') }}</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-info btn-sm prompt-btn" data-prompt="{{ _('Summarize this data') }}">
                            {{ _('Summarize Data') }}
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm prompt-btn" data-prompt="{{ _('Find patterns in this data') }}">
                            {{ _('Find Patterns') }}
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm prompt-btn" data-prompt="{{ _('Show statistics for this data') }}">
                            {{ _('Show Statistics') }}
                        </button>
                        {% if session.excel_file.can_write() %}
                        <button type="button" class="btn btn-outline-primary btn-sm prompt-btn" data-prompt="{{ _('Help me add a new row to the table') }}">
                            {{ _('Add New Data') }}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для голосового ввода -->
<div class="modal fade" id="voiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Voice Message') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="recording-indicator" class="mb-4 d-none">
                    <div class="spinner-grow text-danger" role="status">
                        <span class="visually-hidden">{{ _('Recording...') }}</span>
                    </div>
                    <p class="mt-2">{{ _('Recording... speak now') }}</p>
                    <div id="recording-time" class="fs-4">00:00</div>
                </div>
                
                <div id="voice-controls">
                    <button id="start-recording" class="btn btn-danger btn-lg">
                        <i class="fas fa-microphone"></i> {{ _('Start Recording') }}
                    </button>
                    <button id="stop-recording" class="btn btn-outline-secondary btn-lg d-none">
                        <i class="fas fa-stop"></i> {{ _('Stop') }}
                    </button>
                    <button id="send-voice" class="btn btn-success btn-lg d-none">
                        <i class="fas fa-paper-plane"></i> {{ _('Send') }}
                    </button>
                    <button id="cancel-voice" class="btn btn-outline-danger btn-lg d-none">
                        <i class="fas fa-times"></i> {{ _('Cancel') }}
                    </button>
                </div>
                
                <div id="voice-status" class="mt-3 text-muted small"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatMessages = document.getElementById('chat-messages');
        const sessionId = document.querySelector('.container').dataset.sessionId;
        const typingIndicator = document.getElementById('typing-indicator');
        
        // Прокрутка чата вниз при загрузке страницы
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Функция для добавления нового сообщения в чат
        function addMessage(message, isUserMessage = true, messageType = 'text', messageId = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `d-flex mb-3 ${isUserMessage ? 'justify-content-end' : 'justify-content-start'}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = `${isUserMessage ? 'user-message' : 'assistant-message'} message-content`;
            if (messageId) {
                messageContent.dataset.messageId = messageId;
            }
            
            let contentHtml = '';
            if (messageType === 'voice' && isUserMessage) {
                contentHtml += '<small><i class="fas fa-microphone me-1"></i>Voice Message</small><br>';
            }
            contentHtml += message.replace(/\n/g, '<br>');
            
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
            
            contentHtml += `<div class="message-time">${timeStr}</div>`;
            
            if (!isUserMessage) {
                contentHtml += `
                <div class="action-buttons mt-2" data-message-id="${messageId}">
                    <button class="btn btn-sm btn-outline-primary parse-ai-actions-btn">
                        <i class="fas fa-magic"></i> {{ _('Process Actions') }}
                    </button>
                </div>`;
            }
            
            messageContent.innerHTML = contentHtml;
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // Прокрутка вниз после добавления сообщения
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageContent;
        }
        
        // Функция для отображения системного сообщения
        function addSystemMessage(message, messageId = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'd-flex mb-3 justify-content-center';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'system-message message-content';
            if (messageId) {
                messageContent.dataset.messageId = messageId;
            }
            
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
            
            messageContent.innerHTML = message.replace(/\n/g, '<br>') + 
                                      `<div class="message-time">${timeStr}</div>`;
            
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // Прокрутка вниз после добавления сообщения
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageContent;
        }
        
        // Показать/скрыть индикатор набора
        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }
        
        // Обработка отправки формы
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Добавляем сообщение пользователя в чат
            addMessage(message, true);
            
            // Очищаем поле ввода
            messageInput.value = '';
            
            // Показываем индикатор набора
            showTypingIndicator();
            
            // Блокируем кнопку отправки
            sendButton.disabled = true;
            
            // Отправляем запрос на сервер
            fetch('/api/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                // Скрываем индикатор набора
                hideTypingIndicator();
                
                if (data.success) {
                    // Добавляем ответ ассистента
                    addMessage(data.response, false, 'text', data.message_id);
                } else {
                    // Отображаем ошибку
                    addSystemMessage(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                hideTypingIndicator();
                addSystemMessage(`Error: ${error.message}`);
                console.error('Error sending message:', error);
            })
            .finally(() => {
                // Разблокируем кнопку отправки
                sendButton.disabled = false;
            });
        });
        
        // Быстрые действия
        const promptButtons = document.querySelectorAll('.prompt-btn');
        promptButtons.forEach(button => {
            button.addEventListener('click', function() {
                const prompt = this.dataset.prompt;
                messageInput.value = prompt;
                messageInput.focus();
            });
        });
        
        // Обработка кнопок действий для сообщений ассистента
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('parse-ai-actions-btn') || e.target.parentElement.classList.contains('parse-ai-actions-btn')) {
                const button = e.target.classList.contains('parse-ai-actions-btn') ? e.target : e.target.parentElement;
                const actionButtons = button.closest('.action-buttons');
                const messageId = actionButtons.dataset.messageId;
                
                // Изменяем текст кнопки и делаем её неактивной
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {{ _("Processing...") }}';
                button.disabled = true;
                
                // Отправляем запрос на обработку действий из сообщения
                fetch('/api-actions/parse-ai-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                    },
                    body: JSON.stringify({
                        message_id: messageId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.system_message_id) {
                            // Если были выполнены действия, добавляем системное сообщение
                            const actionsText = data.actions_performed.join('<br>');
                            const errorsText = data.errors && data.errors.length ? '<br>Errors:<br>' + data.errors.join('<br>') : '';
                            const systemMessage = `<strong>Table actions processed:</strong><br>${actionsText}${errorsText}`;
                            
                            addSystemMessage(systemMessage, data.system_message_id);
                        }
                        
                        // Скрываем кнопку действий
                        actionButtons.style.display = 'none';
                    } else {
                        // Возвращаем кнопке исходный вид
                        button.innerHTML = '<i class="fas fa-magic"></i> {{ _("Process Actions") }}';
                        button.disabled = false;
                        
                        // Показываем ошибку
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error processing actions:', error);
                    
                    // Возвращаем кнопке исходный вид
                    button.innerHTML = '<i class="fas fa-magic"></i> {{ _("Process Actions") }}';
                    button.disabled = false;
                    
                    alert('Error processing actions. Please try again.');
                });
            }
        });
        
        // Voice recording functionality
        const voiceButton = document.getElementById('voice-button');
        const voiceModal = new bootstrap.Modal(document.getElementById('voiceModal'));
        const startRecordingBtn = document.getElementById('start-recording');
        const stopRecordingBtn = document.getElementById('stop-recording');
        const sendVoiceBtn = document.getElementById('send-voice');
        const cancelVoiceBtn = document.getElementById('cancel-voice');
        const recordingIndicator = document.getElementById('recording-indicator');
        const voiceControls = document.getElementById('voice-controls');
        const voiceStatus = document.getElementById('voice-status');
        const recordingTime = document.getElementById('recording-time');
        
        let mediaRecorder;
        let audioChunks = [];
        let startTime;
        let recordingTimer;
        
        voiceButton.addEventListener('click', function() {
            voiceModal.show();
            resetVoiceUI();
        });
        
        function resetVoiceUI() {
            startRecordingBtn.classList.remove('d-none');
            stopRecordingBtn.classList.add('d-none');
            sendVoiceBtn.classList.add('d-none');
            cancelVoiceBtn.classList.add('d-none');
            recordingIndicator.classList.add('d-none');
            voiceStatus.textContent = '';
            audioChunks = [];
        }
        
        function updateRecordingTime() {
            const now = Date.now();
            const diff = now - startTime;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        startRecordingBtn.addEventListener('click', function() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.addEventListener('dataavailable', event => {
                        audioChunks.push(event.data);
                    });
                    
                    mediaRecorder.addEventListener('stop', () => {
                        clearInterval(recordingTimer);
                        recordingIndicator.classList.add('d-none');
                        startRecordingBtn.classList.add('d-none');
                        stopRecordingBtn.classList.add('d-none');
                        sendVoiceBtn.classList.remove('d-none');
                        cancelVoiceBtn.classList.remove('d-none');
                        voiceStatus.textContent = 'Recording complete. Send or cancel.';
                    });
                    
                    // Start recording
                    mediaRecorder.start();
                    audioChunks = [];
                    startTime = Date.now();
                    recordingTimer = setInterval(updateRecordingTime, 1000);
                    
                    // Update UI
                    startRecordingBtn.classList.add('d-none');
                    stopRecordingBtn.classList.remove('d-none');
                    recordingIndicator.classList.remove('d-none');
                    voiceStatus.textContent = 'Recording started. Speak now.';
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    voiceStatus.textContent = 'Error accessing microphone. Please check permissions.';
                });
        });
        
        stopRecordingBtn.addEventListener('click', function() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        });
        
        cancelVoiceBtn.addEventListener('click', function() {
            voiceModal.hide();
            resetVoiceUI();
        });
        
        sendVoiceBtn.addEventListener('click', function() {
            if (audioChunks.length === 0) {
                voiceStatus.textContent = 'No recording found. Try again.';
                return;
            }
            
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const formData = new FormData();
            formData.append('session_id', sessionId);
            formData.append('audio', audioBlob, 'voice_message.webm');
            
            voiceStatus.textContent = 'Sending voice message...';
            sendVoiceBtn.disabled = true;
            cancelVoiceBtn.disabled = true;
            
            fetch('/api/send_voice_message', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                voiceModal.hide();
                resetVoiceUI();
                
                if (data.success) {
                    // Добавляем голосовое сообщение пользователя
                    addMessage(data.transcript, true, 'voice');
                    
                    // Показываем индикатор набора
                    showTypingIndicator();
                    
                    // Запрашиваем ответ от ассистента
                    return fetch('/api/get_voice_response', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                        },
                        body: JSON.stringify({
                            message_id: data.message_id
                        })
                    });
                } else {
                    throw new Error(data.error || 'Failed to send voice message');
                }
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                
                if (data.success) {
                    // Добавляем ответ ассистента
                    addMessage(data.response, false, 'text', data.message_id);
                } else {
                    addSystemMessage(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                hideTypingIndicator();
                voiceModal.hide();
                console.error('Voice message error:', error);
                addSystemMessage(`Error: ${error.message}`);
            })
            .finally(() => {
                sendVoiceBtn.disabled = false;
                cancelVoiceBtn.disabled = false;
            });
        });
    });
</script>
{% endblock %}
